# Coraza WAF Configuration for gud
# This file contains additional Coraza directives loaded alongside OWASP CRS.

# Engine settings
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRequestBodyLimit 10485760
SecRequestBodyNoFilesLimit 1048576

# Anomaly scoring mode (default for CRS v4)
SecAction "id:900110,phase:1,pass,nolog,setvar:tx.inbound_anomaly_score_threshold=10,setvar:tx.outbound_anomaly_score_threshold=5"

# Paranoia level (1 = default, 2 = moderate, 3 = high, 4 = max)
SecAction "id:900000,phase:1,pass,nolog,setvar:tx.paranoia_level=1"

# Allowed HTTP methods
SecAction "id:900200,phase:1,pass,nolog,setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# Allowed content types
SecAction "id:900220,phase:1,pass,nolog,setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# --- Rule Exclusions for known false positives ---

# Skip WAF for health check endpoint
SecRule REQUEST_URI "@streq /api/health" "id:10001,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Skip WAF for WebSocket upgrade requests
SecRule REQUEST_HEADERS:Upgrade "@streq websocket" "id:10002,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Allow long message content in POST bodies (chat messages can look like injection)
SecRule REQUEST_URI "@beginsWith /api/channels/" "id:10003,phase:1,pass,nolog,ctl:ruleRemoveTargetById=941100-941999;ARGS:content,ctl:ruleRemoveTargetById=942100-942999;ARGS:content"
SecRule REQUEST_URI "@beginsWith /api/conversations/" "id:10004,phase:1,pass,nolog,ctl:ruleRemoveTargetById=941100-941999;ARGS:content,ctl:ruleRemoveTargetById=942100-942999;ARGS:content"
